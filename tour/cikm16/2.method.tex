\section{POI, Query and Transition}
\label{sec:feature}

The goal of tour recommendation is to suggest a sequence of POIs, $(p_1, \ldots, p_L)$, of length $L$ such that the user's utility is maximised. The user provides the desired start ($p_1=p_s$) and end point ($p_L=p_e$), as well as the number $L$ of POIs desired, from which we propose a trajectory through the city.
The training data consists of a set of tours of varying length in a particular city.
We consider only POIs that have been visited by at least one user in the past, and
construct a graph with POIs as nodes and directed edges representing the observed transitions between pairs of POIs in tours. 


We extract the category, popularity (number of distinct visitors)~\cite{ht10}, total number of visits and average visit duration for each POI.
POIs are grouped into $5$ clusters using K-means according to their geographical locations to reflect their neighbourhood.
Furthermore, since we are constrained by the fact that trajectories have to be of length $L$ and start and end at certain points, we hope to improve the recommendation by using this information.
In other words, we use the \textit{query} $q = (p_s, p_e, L)$ to construct new features by contrasting candidate POIs with $p_s$ and $p_e$.
For each of the POI features (category, neighbourhood, popularity, total visits and average duration),
we construct two new features by taking the difference of the feature in POI $p$ with $p_s$ and $p_e$ respectively.
For the category (and neighbourhood), we set the feature to $1$ when their categories (and cluster identities) are the same and $-1$ otherwise.
For popularity, total visits and average duration, we take the real valued difference.
Lastly, we compute the distance from POI $p$ to $p_s$ (and $p_e$) using the Haversine formula~\cite{haversine},
and also include the required length $L$.


\begin{figure}[t]
\includegraphics[width=\columnwidth]{fig/poi_transmat.png}
\caption{Transition matrices for two POI features from Melbourne: POI category and neighbourhood.
}
\label{fig:transmat}\captionmoveup
\end{figure}


In addition to information about each individual POI, a tour recommendation system would benefit
from capturing the likelihood of going from one POI to another different POI. One option would be to
directly model the probability of going from any POI to any other POI, but this has several weaknesses:
Such a model would be unable to handle a new POI (one that has not yet been visited),
or pairs of existing POIs that do not have an observed transition.
Furthermore, even if we restrict ourselves to known POIs and transitions,
there may be locations which are rarely visited,
leading to significant challenges in estimating the probabilities from empirical data.

We model POI transitions using a Markov chain with discrete 
states by factorising the transition probability ($p_i$ to $p_j$) 
as a product of transition probabilities between pairs of individual POI features, 
assuming independence between these feature-wise transitions.
The popularity, total visits and average duration are discretised by binning
them uniformly into $5$ intervals on the log scale.
These feature-to-feature transitions are estimated from data using maximum likelihood principle.
The POI-POI transition probabilities can be efficiently computed by taking the Kronecker product of 
transition matrices for the individual features,
and then updating it based on three additional constraints as well as appropriate normalisation.
First we disallow self-loops by setting the probability of ($p_i$ to $p_i$) to zero.
Secondly, when multiple POIs have identical (discretised) features, we distribute the probability uniformly among POIs in the group.
Third, we remove feature combinations that has no POI in dataset. 
Figure~\ref{fig:transmat} visualises the transition matrices for two POI features, category and neighbourhood, in Melbourne.
